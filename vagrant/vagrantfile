
$script1 = <<-SCRIPT
apt-get update -y
apt-get install -y ansible-core apache2 php libapache2-mod-php mysql-server python3-pip
ansible-galaxy collection install community.mysql
sudo systemctl enable mysql
apt-get install python3-pip -y
SCRIPT


#spécification de la box (image) pour créer la vm
Vagrant.configure("2") do |config|
  # Common configuration
  config.vm.box = "hashicorp-education/ubuntu-24-04"
  config.vm.box_version = "0.1.0"
  
config.vm.network "forwarded_port", guest: 80, host: 8080
config.vm.network "forwarded_port", guest: 2221, host: 2221
config.vm.network "forwarded_port", guest: 2222, host: 2222
config.vm.network "forwarded_port", guest: 2223, host: 2223
config.vm.network "public_network", ip: "192.168.1.200"

#installer Docker 
 config.vm.provision "shell", name: "install-docker", path: "install-docker.sh"

#installer ansible-core apache2 php libapache2-mod-php php-mysql mysql-server python3-pip 
 config.vm.provision "shell", inline: $script1

#importation de index.php dans la vm
config.vm.provision "shell", inline: <<-SHELL
 sudo chown -R vagrant:vagrant /var/www/html
 
 SHELL
 config.vm.provision "file", source: "webapp/index.php", destination: "/var/www/html/index.php"
 config.vm.provision "file", source: "webapp/request_container.php", destination: "/var/www/html/request_container.php"  
#importation de playbook.yml dans la vm
config.vm.provision "shell", inline: "test -d /home/vagrant/ansible || mkdir /home/vagrant/ansible"
config.vm.provision "shell", inline: <<-SHELL
  sudo chown -R vagrant:vagrant /home/vagrant/ansible
 SHELL
config.vm.provision "file", source: "playbook.yml", destination: "/home/vagrant/ansible/playbook.yml"

#importation du Dockerfile dans la vm + construction de l'image des futurs conteneurs
config.vm.provision "shell", inline: "test -d /home/vagrant/docker || mkdir /home/vagrant/docker"


config.vm.provision "shell", inline: <<-SHELL
  sudo chown -R vagrant:vagrant /home/vagrant/docker
 SHELL
config.vm.provision "file", source: "Dockerfile", destination: "/home/vagrant/docker/Dockerfile"
config.vm.provision "shell", inline: <<-SHELL
   docker build -t ubuntu-ssh /home/vagrant/docker
SHELL
config.vm.provision "shell", inline: "sudo chown -R www-data:www-data /var/www/html"

config.vm.provision :shell, path: "cron.sh"

#execution de playbook.yml


  config.vm.provision "shell", inline:  "ansible-playbook -i localhost, /home/vagrant/ansible/playbook.yml --extra-vars 'first_run=true'"

end







