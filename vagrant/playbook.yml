---
- name: execution des taches
  hosts: docker_hosts

  vars:
    mysql_root_password: "azerty"
    mysql_db_name: "manage_clients_db"
    



  tasks:


    - name: lire le fichier json
      ansible.builtin.slurp:
        src: /var/www/html/users_containers.json
      register: json_file
      when: first_run is not defined


    - name: afficher le contenu du fichier json
      debug:
        msg: "{{ json_file.content | b64decode }}"
      when: first_run is not defined

    - name: extraire les ports
      set_fact:
        port_numbers: "{{ json_file.content | b64decode | from_json | map(attribute='container_port') | list }}"
      when: first_run is not defined



    - name: afficher les ports actifs
      debug:
        msg: "{{ port_numbers }}" 
      when: first_run is not defined

    - name: dÃ©marrer les nouveaux conteneurs
      docker_container:
        name: "container_{{ item }}"
        image: "docker/getting-started"
        state: started
        published_ports:
          - "{{ item }}:80"
      loop: "{{ port_numbers }}"
      when: first_run is not defined and port_numbers | length > 0


